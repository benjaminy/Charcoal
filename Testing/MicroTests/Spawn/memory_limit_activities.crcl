extern "C" {
#include <stdlib.h>
#include <stdio.h>
#include <assert.h>
}

#include <standard_library.crclh>

csemaphore_t sem;

int main( int argc, char ** argv )
{
    int limit, i;
    semaphore_open( &sem, 0 );
    for( limit = 1; limit < 1000000000; limit *= 2 )
    {
        printf( "Lets try spawning %d activities\n", limit ); fflush( stdout );
        activity_p acts = (activity_p)malloc( limit * sizeof( acts[0] ) );
        for( i = 0; i < limit; ++i )
        {
            activate[ &acts[i] ] ()
            {
                semaphore_decr( &sem );
            }
        }
        for( i = 0; i < limit; ++i )
        {
            semaphore_incr( &sem );
        }
        for( i = 0; i < limit; ++i )
        {
            wait_activity_done( &acts[ i ] );
        }
        free( acts );
    }
}
